{% extends 'chatgptbase.html' %}

{% block title %}MUT AI - Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700">
            <button class="new-chat-btn" id="newChatBtn">
                <i class="fas fa-plus"></i>
                <span>New Chat</span>
            </button>
        </div>
        
        <!-- Sessions List -->
        <div class="flex-1 overflow-y-auto" id="sessionsList">
            {% for session in sessions %}
            <div class="session-item" data-session-id="{{ session.id }}">
                <div class="flex-1 truncate">
                    <span class="session-title">{{ session.title }}</span>
                </div>
                <div class="session-actions" style="display: none;">
                    <button class="text-gray-400 hover:text-white p-1" onclick="editSessionTitle('{{ session.id }}')">
                        <i class="fas fa-edit text-sm"></i>
                    </button>
                    <button class="text-gray-400 hover:text-red-400 p-1" onclick="deleteSession('{{ session.id }}')">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- User Menu -->
        <div class="p-4 border-t border-gray-700">
            {% if user.is_authenticated %}
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                    <span class="text-sm font-semibold">{{ user.username.0|upper }}</span>
                </div>
                <div class="flex-1">
                    <div class="text-sm font-medium">{{ user.username }}</div>
                    <div class="text-xs text-gray-400">{{ user.user_type|capfirst }}</div>
                </div>
                <div class="relative">
                    <button class="text-gray-400 hover:text-white" id="userMenuBtn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="space-y-2">
                <a href="{% url 'login' %}" class="block w-full text-center py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition">
                    Login
                </a>
                <a href="{% url 'register' %}" class="block w-full text-center py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    Register
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="main-content">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <button class="text-gray-400 hover:text-white lg:hidden" id="toggleSidebar">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-xl font-semibold">MUT AI</h1>
            </div>
            <div class="flex items-center gap-3">
                <a href="{% url 'knowledge_base' %}" class="text-gray-400 hover:text-white">
                    <i class="fas fa-book"></i>
                </a>
                <a href="{% url 'faqs' %}" class="text-gray-400 hover:text-white">
                    <i class="fas fa-question-circle"></i>
                </a>
                <a href="{% url 'announcements' %}" class="text-gray-400 hover:text-white">
                    <i class="fas fa-bullhorn"></i>
                </a>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div>
                    <h1>Welcome to MUT AI</h1>
                    <p class="text-gray-400 text-lg mt-2">Your intelligent university assistant</p>
                </div>
                
                <div class="suggestion-cards">
                    <div class="suggestion-card" data-suggestion="How do I pay school fees?">
                        <div class="text-blue-400 mb-2"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="font-medium mb-1">School Fees</div>
                        <div class="text-sm text-gray-400">Learn about payment methods</div>
                    </div>
                    
                    <div class="suggestion-card" data-suggestion="Tell me about supplementary exams">
                        <div class="text-green-400 mb-2"><i class="fas fa-file-alt"></i></div>
                        <div class="font-medium mb-1">Exams</div>
                        <div class="text-sm text-gray-400">Supplementary exam information</div>
                    </div>
                    
                    <div class="suggestion-card" data-suggestion="Who is the Vice Chancellor?">
                        <div class="text-purple-400 mb-2"><i class="fas fa-user-tie"></i></div>
                        <div class="font-medium mb-1">Officials</div>
                        <div class="text-sm text-gray-400">University leadership</div>
                    </div>
                    
                    <div class="suggestion-card" data-suggestion="Where is the Finance Office?">
                        <div class="text-orange-400 mb-2"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="font-medium mb-1">Locations</div>
                        <div class="text-sm text-gray-400">Find university offices</div>
                    </div>
                </div>
            </div>
            
            <!-- Messages will be appended here -->
        </div>
        
        <!-- Input Area -->
        <div class="input-area">
            <div class="input-container">
                <textarea 
                    id="messageInput" 
                    class="input-box" 
                    placeholder="Ask me anything about Murang'a University..."
                    rows="1"
                    maxlength="2000"
                ></textarea>
                <button class="send-button" id="sendBtn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="text-center text-xs text-gray-500 mt-2">
                MUT AI can make mistakes. Verify important information.
            </div>
        </div>
    </div>
</div>

<!-- User Menu Dropdown (if needed) -->
<div id="userDropdown" class="dropdown-menu" style="display: none; bottom: 70px; left: 20px;">
    <a href="{% url 'profile' %}" class="dropdown-item">
        <i class="fas fa-user"></i> Profile
    </a>
    <a href="{% url 'settings' %}" class="dropdown-item">
        <i class="fas fa-cog"></i> Settings
    </a>
    {% if user.is_staff %}
    <a href="{% url 'analytics' %}" class="dropdown-item">
        <i class="fas fa-chart-bar"></i> Analytics
    </a>
    {% endif %}
    <hr class="border-gray-700 my-1">
    <a href="{% url 'logout' %}" class="dropdown-item">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentSessionId = null;
    let isLoading = false;
    
    $(document).ready(function() {
        initializeApp();
        setupEventListeners();
    });
    
    function initializeApp() {
        // Check if user has existing sessions
        const firstSession = $('.session-item').first();
        if (firstSession.length > 0) {
            loadSession(firstSession.data('session-id'));
        } else {
            // Create a new session for first-time users
            createNewSession();
        }
    }
    
    function setupEventListeners() {
        // New chat button
        $('#newChatBtn').click(createNewSession);
        
        // Session items
        $(document).on('click', '.session-item', function() {
            const sessionId = $(this).data('session-id');
            loadSession(sessionId);
        });
        
        // Session hover actions
        $(document).on('mouseenter', '.session-item', function() {
            $(this).find('.session-actions').show();
        }).on('mouseleave', '.session-item', function() {
            $(this).find('.session-actions').hide();
        });
        
        // Send message
        $('#sendBtn').click(sendMessage);
        
        // Message input
        $('#messageInput').on('input', function() {
            autoResize(this);
            $('#sendBtn').prop('disabled', !$(this).val().trim());
        }).on('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if ($(this).val().trim() && !isLoading) {
                    sendMessage();
                }
            }
        });
        
        // Suggestion cards
        $(document).on('click', '.suggestion-card', function() {
            const suggestion = $(this).data('suggestion');
            $('#messageInput').val(suggestion);
            $('#sendBtn').prop('disabled', false);
            sendMessage();
        });
        
        // Toggle sidebar (mobile)
        $('#toggleSidebar').click(function() {
            $('#sidebar').toggleClass('collapsed');
        });
        
        // User menu
        $('#userMenuBtn').click(function(e) {
            e.stopPropagation();
            $('#userDropdown').toggle();
        });
        
        $(document).click(function() {
            $('#userDropdown').hide();
        });
    }
    
    function createNewSession() {
        $.ajax({
            url: '{% url "chat_session_create" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ title: 'New Chat' }),
            success: function(response) {
                if (response.success) {
                    currentSessionId = response.session_id;
                    
                    // Add to sidebar
                    const sessionHtml = `
                        <div class="session-item active" data-session-id="${response.session_id}">
                            <div class="flex-1 truncate">
                                <span class="session-title">${response.title}</span>
                            </div>
                            <div class="session-actions" style="display: none;">
                                <button class="text-gray-400 hover:text-white p-1" onclick="editSessionTitle('${response.session_id}')">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                                <button class="text-gray-400 hover:text-red-400 p-1" onclick="deleteSession('${response.session_id}')">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    $('.session-item').removeClass('active');
                    $('#sessionsList').prepend(sessionHtml);
                    
                    // Clear messages
                    $('#chatMessages').html('<div class="empty-state" id="emptyState"><div><h1>Welcome to MUT AI</h1><p class="text-gray-400 text-lg mt-2">Your intelligent university assistant</p></div></div>');
                    showEmptyState();
                }
            },
            error: function() {
                showToast('Failed to create new chat', 'error');
            }
        });
    }
    
    function loadSession(sessionId) {
        currentSessionId = sessionId;
        
        // Update active state
        $('.session-item').removeClass('active');
        $(`.session-item[data-session-id="${sessionId}"]`).addClass('active');
        
        // Load messages
        $.ajax({
            url: `/api/chat/session/${sessionId}/`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    $('#chatMessages').empty();
                    
                    if (response.messages.length === 0) {
                        showEmptyState();
                    } else {
                        response.messages.forEach(msg => {
                            appendMessage(msg.role, msg.content, false);
                        });
                        scrollToBottom();
                    }
                }
            },
            error: function() {
                showToast('Failed to load chat', 'error');
            }
        });
    }
    
    function sendMessage() {
        if (isLoading) return;
        
        const message = $('#messageInput').val().trim();
        if (!message) return;
        
        if (!currentSessionId) {
            showToast('Please create a new chat first', 'error');
            return;
        }
        
        isLoading = true;
        $('#sendBtn').prop('disabled', true);
        $('#messageInput').val('').css('height', 'auto');
        
        // Hide empty state
        $('#emptyState').remove();
        
        // Show user message
        appendMessage('user', message);
        
        // Show loading
        const loadingId = 'loading-' + Date.now();
        appendLoadingMessage(loadingId);
        
        // Send to server
        $.ajax({
            url: '{% url "chat_send_message" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                session_id: currentSessionId,
                message: message
            }),
            success: function(response) {
                if (response.success) {
                    // Remove loading
                    $(`#${loadingId}`).remove();
                    
                    // Show assistant response
                    appendMessage('assistant', response.assistant_message.content);
                    
                    // Update session title if changed
                    if (response.session_title) {
                        $(`.session-item[data-session-id="${currentSessionId}"] .session-title`).text(response.session_title);
                    }
                }
            },
            error: function(xhr) {
                $(`#${loadingId}`).remove();
                
                let errorMsg = 'Sorry, something went wrong. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                
                appendMessage('assistant', errorMsg);
            },
            complete: function() {
                isLoading = false;
                $('#sendBtn').prop('disabled', false);
                $('#messageInput').focus();
            }
        });
    }
    
    function appendMessage(role, content, animate = true) {
        const isUser = role === 'user';
        const avatarIcon = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
        const avatarClass = isUser ? 'user-avatar' : 'assistant-avatar';
        
        const messageHtml = `
            <div class="message ${role}" ${animate ? 'style="animation: fadeIn 0.3s ease;"' : ''}>
                ${!isUser ? `<div class="message-avatar ${avatarClass}">${avatarIcon}</div>` : ''}
                <div class="message-content">
                    ${escapeHtml(content).replace(/\n/g, '<br>')}
                </div>
                ${isUser ? `<div class="message-avatar ${avatarClass}">${avatarIcon}</div>` : ''}
            </div>
        `;
        
        $('#chatMessages').append(messageHtml);
        scrollToBottom();
    }
    
    function appendLoadingMessage(id) {
        const loadingHtml = `
            <div class="message assistant" id="${id}">
                <div class="message-avatar assistant-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        `;
        
        $('#chatMessages').append(loadingHtml);
        scrollToBottom();
    }
    
    function showEmptyState() {
        const emptyStateHtml = `
            <div class="empty-state" id="emptyState">
                <div>
                    <h1>Welcome to MUT AI</h1>
                    <p class="text-gray-400 text-lg mt-2">Your intelligent university assistant</p>
                </div>
                
                <div class="suggestion-cards">
                    <div class="suggestion-card" data-suggestion="How do I pay school fees?">
                        <div class="text-blue-400 mb-2"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="font-medium mb-1">School Fees</div>
                        <div class="text-sm text-gray-400">Learn about payment methods</div>
                    </div>
                    
                    <div class="suggestion-card" data-suggestion="Tell me about supplementary exams">
                        <div class="text-green-400 mb-2"><i class="fas fa-file-alt"></i></div>
                        <div class="font-medium mb-1">Exams</div>
                        <div class="text-sm text-gray-400">Supplementary exam information</div>
                    </div>
                    
                    <div class="suggestion-card" data-suggestion="Who is the Vice Chancellor?">
                        <div class="text-purple-400 mb-2"><i class="fas fa-user-tie"></i></div>
                        <div class="font-medium mb-1">Officials</div>
                        <div class="text-sm text-gray-400">University leadership</div>
                    </div>
                    
                    <div class="suggestion-card" data-suggestion="Where is the Finance Office?">
                        <div class="text-orange-400 mb-2"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="font-medium mb-1">Locations</div>
                        <div class="text-sm text-gray-400">Find university offices</div>
                    </div>
                </div>
            </div>
        `;
        
        $('#chatMessages').html(emptyStateHtml);
    }
    
    function scrollToBottom() {
        const messagesDiv = $('#chatMessages');
        messagesDiv.scrollTop(messagesDiv[0].scrollHeight);
    }
    
    function deleteSession(sessionId) {
        if (!confirm('Are you sure you want to delete this chat?')) return;
        
        $.ajax({
            url: `/api/chat/session/${sessionId}/delete/`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    $(`.session-item[data-session-id="${sessionId}"]`).fadeOut(300, function() {
                        $(this).remove();
                        
                        // If deleted current session, create new one
                        if (currentSessionId === sessionId) {
                            createNewSession();
                        }
                    });
                    
                    showToast('Chat deleted successfully', 'success');
                }
            },
            error: function() {
                showToast('Failed to delete chat', 'error');
            }
        });
    }
    
    function editSessionTitle(sessionId) {
        const sessionItem = $(`.session-item[data-session-id="${sessionId}"]`);
        const currentTitle = sessionItem.find('.session-title').text();
        
        const newTitle = prompt('Enter new title:', currentTitle);
        if (!newTitle || newTitle === currentTitle) return;
        
        $.ajax({
            url: `/api/chat/session/${sessionId}/rename/`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ title: newTitle }),
            success: function(response) {
                if (response.success) {
                    sessionItem.find('.session-title').text(response.title);
                    showToast('Title updated successfully', 'success');
                }
            },
            error: function() {
                showToast('Failed to update title', 'error');
            }
        });
    }
</script>
{% endblock %}